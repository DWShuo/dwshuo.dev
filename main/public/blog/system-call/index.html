<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/blog/styles.28b715d0c0238008b3e5.css">:root{--reach-skip-nav:1}[data-reach-skip-nav-link]{border:0;clip:rect(0 0 0 0);height:1px;width:1px;margin:-1px;padding:0;overflow:hidden;position:absolute}[data-reach-skip-nav-link]:focus{padding:1rem;position:fixed;top:10px;left:10px;background:#fff;z-index:1;width:auto;height:auto;clip:auto}</style><meta name="generator" content="Gatsby 2.24.67"/><title data-react-helmet="true">System calls | [errorcodes@DWS ~]$</title><meta data-react-helmet="true" name="description" content="
This article is part of a series on the linux kernel. Today we will be looking at 
Linux system calls, and how you can implement your own…"/><meta data-react-helmet="true" property="og:title" content="System calls"/><meta data-react-helmet="true" property="og:description" content="
This article is part of a series on the linux kernel. Today we will be looking at 
Linux system calls, and how you can implement your own…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:creator" content="David S. Wang"/><meta data-react-helmet="true" name="twitter:title" content="System calls"/><meta data-react-helmet="true" name="twitter:description" content="
This article is part of a series on the linux kernel. Today we will be looking at 
Linux system calls, and how you can implement your own…"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><link as="script" rel="preload" href="/blog/webpack-runtime-a91d46373f0daea63f12.js"/><link as="script" rel="preload" href="/blog/styles-9411612e31e4f14527d1.js"/><link as="script" rel="preload" href="/blog/framework-256fdde5199f9087be1b.js"/><link as="script" rel="preload" href="/blog/app-3d8cf471c6d272398fde.js"/><link as="script" rel="preload" href="/blog/commons-3983a7b41e047dedbd62.js"/><link as="script" rel="preload" href="/blog/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-af5dedea4bd4351ecda6.js"/><link as="fetch" rel="preload" href="/blog/page-data/system-call/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/sq/d/2744905544.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/sq/d/3090755652.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/sq/d/386998304.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/sq/d/764694655.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="15p9t3j">body{--theme-ui-colors-text:var(--theme-ui-colors-text,#282c35);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#007acc);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#1B1F23);--theme-ui-colors-muted:var(--theme-ui-colors-muted,hsla(0,0%,0%,0.2));--theme-ui-colors-highlight:var(--theme-ui-colors-highlight,rgba(255,229,100,0.2));--theme-ui-colors-heading:var(--theme-ui-colors-heading,#282c35);--theme-ui-colors-prism-background:var(--theme-ui-colors-prism-background,#011627);--theme-ui-colors-prism-comment:var(--theme-ui-colors-prism-comment,#809393);--theme-ui-colors-prism-string:var(--theme-ui-colors-prism-string,#addb67);--theme-ui-colors-prism-var:var(--theme-ui-colors-prism-var,#d6deeb);--theme-ui-colors-prism-number:var(--theme-ui-colors-prism-number,#f78c6c);--theme-ui-colors-prism-constant:var(--theme-ui-colors-prism-constant,#82aaff);--theme-ui-colors-prism-punctuation:var(--theme-ui-colors-prism-punctuation,#c792ea);--theme-ui-colors-prism-className:var(--theme-ui-colors-prism-className,#ffc98b);--theme-ui-colors-prism-tag:var(--theme-ui-colors-prism-tag,#ffa7c4);--theme-ui-colors-prism-boolean:var(--theme-ui-colors-prism-boolean,#ff5874);--theme-ui-colors-prism-property:var(--theme-ui-colors-prism-property,#80cbc4);--theme-ui-colors-prism-namespace:var(--theme-ui-colors-prism-namespace,#b2ccd6);--theme-ui-colors-prism-highlight:var(--theme-ui-colors-prism-highlight,hsla(207,95%,15%,1));color:var(--theme-ui-colors-text,#282c35);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,rgba(255,255,255,0.86));--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#232129);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#D9BAE8);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,rgba(255,255,255,0.86));--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,hsla(0,0%,100%,0.2));--theme-ui-colors-highlight:var(--theme-ui-colors-modes-dark-highlight,#663399);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);}</style><style data-emotion-css="8ir1vi">*{box-sizing:border-box;}body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="ocpejr">.css-ocpejr{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;}</style><div class="css-ocpejr"><header><style data-emotion-css="o7eq5i">.css-o7eq5i{color:var(--theme-ui-colors-primary,#007acc);}</style><a class="css-o7eq5i" href="#reach-skip-nav" data-reach-skip-link="" data-reach-skip-nav-link="">Skip to content</a><style data-emotion-css="1ufxd81">.css-1ufxd81{max-width:672px;margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px;padding-top:32px;}</style><div class="css-1ufxd81"><style data-emotion-css="4c94nt">.css-4c94nt{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-bottom:32px;}</style><div class="css-4c94nt"><style data-emotion-css="1qd1r5f">.css-1qd1r5f{margin-top:0;margin-bottom:0;}</style><p class="css-1qd1r5f"><style data-emotion-css="1febbns">.css-1febbns{box-shadow:none;-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-primary,#007acc);}</style><style data-emotion-css="1a7e4c0">.css-1a7e4c0{color:var(--theme-ui-colors-primary,#007acc);box-shadow:none;-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-primary,#007acc);}</style><a class="css-1a7e4c0" href="/blog/">[errorcodes@DWS ~]$</a></p></div></div></header><div id="reach-skip-nav" data-reach-skip-nav-content=""></div><div><style data-emotion-css="1in33uw">.css-1in33uw{max-width:672px;margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px;padding-top:32px;padding-bottom:32px;}</style><div class="css-1in33uw"><main><article><header><h1 class="css-0">System calls</h1><style data-emotion-css="1h1xv8c">.css-1h1xv8c{font-size:14px;margin-top:-16px;margin-bottom:16px;}</style><style data-emotion-css="dv5tmu">.css-dv5tmu{font-size:14px;margin-top:-16px;margin-bottom:16px;}.css-dv5tmu code{font-size:inherit;}</style><p class="css-dv5tmu">October 29, 2018</p></header><section><style data-emotion-css="1ek8oqb">.css-1ek8oqb code{font-size:inherit;}</style><p class="css-1ek8oqb"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:760px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:39.42028985507247%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAABibAAAYmwFJdYOUAAABlklEQVQY01VRy0rDUBDNX7hx40JEXIiICrpQRFeKWupG60IREd1LXepSUfBBSzW0StJHetPcpJXaFhVBjdD6/AZtYgSxTaP0kRidBpQ6HC7DzBzOmTuEaZqVSqVcLpdKpWKxCC/khmF818SX+VWGMnQtwCgAiASMRqNRLhymfb6DfTJEUYhh0uk0cEwrIJEkicOYYlnP4aH7wEdHWAYhKZslQIqLRBiMgzwfxFxI4APhsCiKteRnWfZ79uLDowmbPWEbPxoaoba2n2SZAAMsxtzCIlSPJxyJMXvQuXx9ewMcXddhI0iyyovf5T7r6rnoG7jsHzzp7KY3Np8UpWobYZzq6X2sb7hvbX+oq2ds4yei+P72piiKLMsfmnb3+ECTJJqcYi0wkw7K5QI7VdugjJacwvQsPzcvzMz6V1bF/zuDQ3pn97yp5aqtQ2zrOG1sptfWn18t5VgsxsXjXDIJwKkUEoRMJlNLBn0WIdbrZUkSEPF6Q4EA/CIBbU3T1Fyu8It8Lgc3qz2VoetqoVD4/PxDXlXhnD8YLHMQgHL1zQAAAABJRU5ErkJggg==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image css-0" alt="stats" title="stats" src="/blog/static/aa86e53a7f5b27ed5304b595ebbb82ce/3c051/bg.png" srcSet="/blog/static/aa86e53a7f5b27ed5304b595ebbb82ce/e4d6b/bg.png 345w,/blog/static/aa86e53a7f5b27ed5304b595ebbb82ce/1e043/bg.png 690w,/blog/static/aa86e53a7f5b27ed5304b595ebbb82ce/3c051/bg.png 760w" sizes="(max-width: 760px) 100vw, 760px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span>
This article is part of a series on the linux kernel. Today we will be looking at
Linux system calls, and how you can implement your own.</p><p class="css-1ek8oqb">To start off if you haven’t already set up your enviroment for kernel development,
you can click here to follow a guide I wrote on that topic. </p><style data-emotion-css="h7w91b">.css-h7w91b{pointer-events:painted;}.css-h7w91b a{visibility:hidden;}.css-h7w91b:hover a{visibility:visible;}</style><h2 id="proposing-a-problem" class="css-h7w91b"><style data-emotion-css="vvm4x1">.css-vvm4x1{margin-left:-20px;padding-right:4px;color:var(--theme-ui-colors-primary,#007acc);}</style><a href="#proposing-a-problem" aria-label="Proposing a problem" class="css-vvm4x1"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Proposing a problem</h2><p class="css-1ek8oqb">Instead of writing a system call that doesn’t really do anything, lets make things
a little more intresting. I will propose a probelm and we will attempt to resolve
it by implmenting our very own system call.</p><p class="css-1ek8oqb">In this problem, we have a basic server and client written in C, the code for both
can be <a href="https://github.com/DWShuo/syscall-demo" target="_blank" class="css-o7eq5i">found here</a>.</p><p class="css-1ek8oqb">The server will attempt to send 5 messages to a connected client, while the client
displays those messages as they are received. </p><p class="css-1ek8oqb">Below, is a small snippit from our client code.</p><style data-emotion-css="f4r2wo">.css-f4r2wo{font-family:Menlo,monospace;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;margin-bottom:8px;color:white;background-color:var(--theme-ui-colors-prism-background,#011627);overflow:auto;border-radius:10px;padding:16px;}.css-f4r2wo .attr-name{font-style:italic;}.css-f4r2wo .comment{color:var(--theme-ui-colors-prism-comment,#809393);}.css-f4r2wo .attr-name,.css-f4r2wo .string,.css-f4r2wo .url{color:var(--theme-ui-colors-prism-string,#addb67);}.css-f4r2wo .variable{color:var(--theme-ui-colors-prism-var,#d6deeb);}.css-f4r2wo .number{color:var(--theme-ui-colors-prism-number,#f78c6c);}.css-f4r2wo .builtin,.css-f4r2wo .char,.css-f4r2wo .constant,.css-f4r2wo .function{color:var(--theme-ui-colors-prism-constant,#82aaff);}.css-f4r2wo .punctuation,.css-f4r2wo .selector,.css-f4r2wo .doctype{color:var(--theme-ui-colors-prism-punctuation,#c792ea);}.css-f4r2wo .class-name{color:var(--theme-ui-colors-prism-className,#ffc98b);}.css-f4r2wo .tag,.css-f4r2wo .operator,.css-f4r2wo .keyword{color:var(--theme-ui-colors-prism-tag,#ffa7c4);}.css-f4r2wo .boolean{color:var(--theme-ui-colors-prism-boolean,#ff5874);}.css-f4r2wo .property{color:var(--theme-ui-colors-prism-property,#80cbc4);}.css-f4r2wo .namespace{color:var(--theme-ui-colors-prism-namespace,#b2ccd6);}.css-f4r2wo .highlight{background:hsla(0,0%,40%,.5);}</style><style data-emotion-css="1q7q4hh">.css-1q7q4hh{font-family:Menlo,monospace;font-size:inherit;}</style><style data-emotion-css="1eu4vb7">.css-1eu4vb7{font-family:Menlo,monospace;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;margin-bottom:8px;color:white;background-color:var(--theme-ui-colors-prism-background,#011627);overflow:auto;border-radius:10px;padding:16px;font-family:Menlo,monospace;font-size:inherit;}.css-1eu4vb7 .attr-name{font-style:italic;}.css-1eu4vb7 .comment{color:var(--theme-ui-colors-prism-comment,#809393);}.css-1eu4vb7 .attr-name,.css-1eu4vb7 .string,.css-1eu4vb7 .url{color:var(--theme-ui-colors-prism-string,#addb67);}.css-1eu4vb7 .variable{color:var(--theme-ui-colors-prism-var,#d6deeb);}.css-1eu4vb7 .number{color:var(--theme-ui-colors-prism-number,#f78c6c);}.css-1eu4vb7 .builtin,.css-1eu4vb7 .char,.css-1eu4vb7 .constant,.css-1eu4vb7 .function{color:var(--theme-ui-colors-prism-constant,#82aaff);}.css-1eu4vb7 .punctuation,.css-1eu4vb7 .selector,.css-1eu4vb7 .doctype{color:var(--theme-ui-colors-prism-punctuation,#c792ea);}.css-1eu4vb7 .class-name{color:var(--theme-ui-colors-prism-className,#ffc98b);}.css-1eu4vb7 .tag,.css-1eu4vb7 .operator,.css-1eu4vb7 .keyword{color:var(--theme-ui-colors-prism-tag,#ffa7c4);}.css-1eu4vb7 .boolean{color:var(--theme-ui-colors-prism-boolean,#ff5874);}.css-1eu4vb7 .property{color:var(--theme-ui-colors-prism-property,#80cbc4);}.css-1eu4vb7 .namespace{color:var(--theme-ui-colors-prism-namespace,#b2ccd6);}.css-1eu4vb7 .highlight{background:hsla(0,0%,40%,.5);}</style><pre class="language-c prism-code language-c css-1eu4vb7"><div class="token-line"><span class="token keyword">void</span><span class="token plain"> </span><span class="token function">recv_msg</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token plain"> sockfd</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">char</span><span class="token plain"> buffer</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><style data-emotion-css="1baulvz">.css-1baulvz{display:inline-block;}</style><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">//Why does this brick our code?</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token plain">sockfd</span><span class="token punctuation">,</span><span class="token plain">buffer</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span><span class="token plain">buffer</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;No more data\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-1ek8oqb">The code snippet is simply a function wrapped around the typical client recv
procedures, the only exception being the sleep call. </p><img src="/blog/ce154d37eb250ef86b9376f34b898548/broken.gif" alt="drawing" width="600" class="css-0"/><p class="css-1ek8oqb">As we can see the sleep call breaks our code quite a bit, we only see three out of
the five messages on the client side. In the next section we will attempt to solve
this by writing our own system call.</p><h2 id="setting-up-system-calls" class="css-h7w91b"><a href="#setting-up-system-calls" aria-label="Setting up system calls" class="css-vvm4x1"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up system calls</h2><p class="css-1ek8oqb">System calls can be thought of as interrupts, in fact it is implmented as software
interrupts. To explain this we can take a look at the <style data-emotion-css="1pnz7gf">.css-1pnz7gf{border-radius:0.3em;color:var(--theme-ui-colors-secondary,#1B1F23);background-color:var(--theme-ui-colors-highlight,rgba(255,229,100,0.2));padding-top:0.15em;padding-bottom:0.05em;padding-left:0.2em;padding-right:0.2em;}</style><code class="css-1pnz7gf">syscall</code> assembly
instruction.</p><p class="css-1ek8oqb">Without getting to much into low level assembly and registers, the <code class="css-1pnz7gf">syscall</code>
instruction causes an exception and transfers control to an exceptions handler,
the way it determines which exception handler to call is by grabbing the system
call number from the general purpose registers, most likely <code class="css-1pnz7gf">rax</code> if you are
using <code class="css-1pnz7gf">x86_64</code></p><p class="css-1ek8oqb">System call numbers are unique numbers assigned to each system call. These unique
number are stored in the systemcall table located at
<code class="css-1pnz7gf">/arch/x86/entry/syscall/syscall_64.tbl</code>.</p><p class="css-1ek8oqb">Our first step then is to add our custom system call to this table. Go ahead and
open up the table using your favorite text editor, and navigate down to the end of
64-bit syscall entries, for me the last syscall number was 334, this could be
different for you. </p><img src="/blog/0610c373cab1f79026b1386e133a3a35/systable.gif" alt="drawing" width="600" class="css-0"/><pre class="prism-code language-css-1q7q4hh css-1eu4vb7"><div class="token-line"><span class="token plain">335   common  read_lines       __x64_sys_read_lines</span></div></pre><p class="css-1ek8oqb">The above is what my system call entry looks like. Note that each column is
seperated by tabs not spaces.</p><p class="css-1ek8oqb">The first number indicates the syscall number, I choose 335 since its the next
available number after 334.</p><p class="css-1ek8oqb">The second column <code class="css-1pnz7gf">common</code> indicates that this system call is used by both 32-bit
and 64-bit CPUs.</p><p class="css-1ek8oqb">The third column indicates the system call’s name, in this case <code class="css-1pnz7gf">read_lines</code></p><p class="css-1ek8oqb">Finally the fourth column indicates the name of the function implmenting it,
convention dictates that it should be prefixed with <code class="css-1pnz7gf">sys_</code>.</p><h2 id="writing-system-calls" class="css-h7w91b"><a href="#writing-system-calls" aria-label="Writing system calls" class="css-vvm4x1"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writing system calls</h2><p class="css-1ek8oqb">The final step in making our own system call is to write the system call function.
Tradtionally miscellaneous system calls should be written in <code class="css-1pnz7gf">kernel/sys.c</code>, but
since our system call modifies read behavior we add our changes to
<code class="css-1pnz7gf">fs/read_write.c</code>.</p><p class="css-1ek8oqb">Now if we recall the original problem, where by adding the sleep call in the client,
we create a unwanted behavior where only three out of the five messages received
were being displayed.</p><p class="css-1ek8oqb">The culprit behind this behavior has to do with C string’s null terminators. Recall
that all C strings are terminate by <code class="css-1pnz7gf">&quot;\0&quot;</code> thus sleeping in between receives, we
end up stacking strings behind strings. Now think about how printf would behave if
we pass it one of these string, how would it know when to stop? </p><p class="css-1ek8oqb">Below is the system call solution to fix our problem. </p><pre class="language-c prism-code language-c css-1eu4vb7"><div class="token-line"><span class="token function">SYSCALL_DEFINE3</span><span class="token punctuation">(</span><span class="token plain">read_lines</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token plain"> fd</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">char</span><span class="token plain"> __user </span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token plain"> bf</span><span class="token punctuation">,</span><span class="token plain"> size_t</span><span class="token punctuation">,</span><span class="token plain"> count</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">int</span><span class="token plain"> read_count </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">int</span><span class="token plain"> single_read_count</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">char</span><span class="token plain"> __user </span><span class="token operator">*</span><span class="token plain"> last</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  last </span><span class="token operator">=</span><span class="token plain"> buf </span><span class="token operator">+</span><span class="token plain"> count </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    single_read_count </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">ksys_read</span><span class="token punctuation">(</span><span class="token plain">fd</span><span class="token punctuation">,</span><span class="token plain"> last</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">single_read_count </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// We have exhausted the input stream</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> read_count</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    buf</span><span class="token punctuation">[</span><span class="token plain">read_count</span><span class="token operator">++</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">last</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">read_count </span><span class="token operator">==</span><span class="token plain"> count</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// We have exhausted the output buffer </span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> read_count</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token plain">last </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string">&#x27;\0&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain">   </span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// We have reached the null terminator</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> read_count</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Something is really wrong here.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-1ek8oqb">One thing that stands out the most from this code is the function decleration,
instead of the usual C style function decleration, we have this strange
<code class="css-1pnz7gf">SYSCALL_DEFINE3</code> decleration. </p><p class="css-1ek8oqb"><code class="css-1pnz7gf">SYSCALL_DEFINE</code> is acutally a class of MACROS defined in
<code class="css-1pnz7gf">include/linux/syscalls.h</code>. If we look at the signature of <code class="css-1pnz7gf">SYSCALL_DEFINE3</code> we
see that it first takes in the syscall name, the type of the first argument, the
first argument, the type of the second argument, the second argument, and so on.
It is then clear that the 3 in <code class="css-1pnz7gf">SYSCALL_DEFINE3</code> indicates the number of arguments
the syscall takes in.</p><p class="css-1ek8oqb">The code itself is rather simplistic, we keep a counter while we read our input.
Once we reach the max buffer size, or hit an null terminator, we return the number
of bytes read, just like how the original read system call would do.</p><p class="css-1ek8oqb">Now all we need to do is build our kernel and we should be good to go.</p><pre class="prism-code language-css-1q7q4hh css-1eu4vb7"><div class="token-line"><span class="token plain">make</span></div><div class="token-line"><span class="token plain">sudo make modules_install</span></div><div class="token-line"><span class="token plain">sudo make install</span></div></pre><p class="css-1ek8oqb">Followed by a reboot, make sure to select you new kernel, although by deafult grub
should select the newest version of the kernel.</p><p class="css-1ek8oqb">To use our new system call we need to make some small changes to our client.c </p><pre class="language-c prism-code language-c css-1eu4vb7"><div class="token-line"><span class="token macro property">#</span><span class="token macro property directive keyword">define</span><span class="token macro property"> SYS_read_lines 335</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">void</span><span class="token plain"> </span><span class="token function">recv_msg</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token plain"> sockfd</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">char</span><span class="token plain"> buffer</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ssize_t nbytes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">//no longer break our code</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">syscall</span><span class="token punctuation">(</span><span class="token plain">SYS_read_lines</span><span class="token punctuation">,</span><span class="token plain">buffer</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span><span class="token plain">buffer</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;No more data\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-1ek8oqb">First we defined our syscall and gave it a name, next we use the <code class="css-1pnz7gf">syscall()</code>
function provided by the <code class="css-1pnz7gf">GNU C library</code> to call our system call. The provided
syscall function handles the syscall interrupt for us, such that we dont have to
trigger it manually.</p><undefined><img src="/blog/1eb46f8827c13e568644a3f968243798/fixed.gif" alt="drawing" width="600" class="css-0"/>
As you can see our system call fixed the problem we had orginally proposed. 
Congratulations now you know how to write your own system calls. </undefined><h2 id="bonus-creating-kernel-patch" class="css-h7w91b"><a href="#bonus-creating-kernel-patch" aria-label="Bonus: Creating kernel patch" class="css-vvm4x1"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bonus: Creating kernel patch</h2><p class="css-1ek8oqb">Now that you have made your own system call. I bet you are excited to share your
awesome new syscall with your friends, but how would you go about sharing it? I hope
you are not thinking about sending the entire kernel source code to them.</p><p class="css-1ek8oqb">We can easily share our kernel changes by creating a kernel patch.</p><p class="css-1ek8oqb">If you’ve followed my previous guide on how to setup your enviroment for kernel
devolpment, then you can just followed the steps below, otherwise some modifications
might be required.</p><p class="css-1ek8oqb"><strong class="css-0">Creating kernel patch:</strong></p><ol class="css-0"><li class="css-1ek8oqb">First run the command <code class="css-1pnz7gf">make mrproper</code> in both linux-4.18.5-original and linux-4.18.5-dev, this gets rid of any intermediate build files we have left over, we dont want to include those in our patch file.</li><li class="css-1ek8oqb">Next we run <code class="css-1pnz7gf">diff -rcNP linux-4.9.45-original linux-4.18.5-dev -x signing_key.* -x x509.genkey -x fixdep -x objtool -x inat-tables.c &gt; mypatch.diff</code></li></ol><p class="css-1ek8oqb"><strong class="css-0">Applying kernel patch:</strong></p><ol class="css-0"><li class="css-1ek8oqb">Navigate to the directory where you want to apply the kernel patch eg. <code class="css-1pnz7gf">cd linux-4.18.5-dev</code></li><li class="css-1ek8oqb">Next run <code class="css-1pnz7gf">patch -p1 &lt; ../mypatch.diff</code></li></ol></section></article></main><style data-emotion-css="1i8tjli">.css-1i8tjli{margin-top:32px;padding-top:16px;}</style><footer class="css-1i8tjli"><style data-emotion-css="1u77lb1">.css-1u77lb1{border-color:var(--theme-ui-colors-muted,hsla(0,0%,0%,0.2));}</style><hr class="css-1u77lb1"/><style data-emotion-css="j6r63x">.css-j6r63x{margin-bottom:32px;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><style data-emotion-css="u5xevn">.css-u5xevn{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:32px;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-u5xevn"><style data-emotion-css="1emx3y6">.css-1emx3y6{margin-right:8px;margin-bottom:0;width:48px;min-width:48px;border-radius:99999px;}</style><div class="css-1emx3y6 gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:48px;height:48px"><img aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAPoAAAD6AG1e1JrAAADfklEQVQ4yy2UaSusYRjH7/eSMJYwCTH2MAzZ9/XYZixjOQzJvpdtwsjY910TJURSyL5FSZIir7zyEXyJ8/PMuV9Mz/14/td/ua6L+Cud8vLy6urq2trapqYmnrOzs/Pz89va2jIyMuLj47mmpKQkJycnJCREREQ4OTnZ2dkFBweLmpoavktPT29ubq6vr8/KyvLx8XF0dLSxsfH19QUJng94n5aWlpSUxJvIyEiVSsVVVFZWajSavLy8np6ewsJCLy8vMB4eHpS3tramRGpqanFx8R/pAEhMTIyLi0NISUmJaGlpQXBFRcXAwAD3qKgopVIJ3s3NzdnZ2dLSMigoqKysLCcnJzc3NzMzk1rgscBLsbS0NDU1NTY2NjExgYWioqLBwUGqQII8+ClEaY10MI9B8HjR6XRia2trZWVlZmZmcnKyvb2d5+XlZfw3NDSo1Wo/Pz9KIK1AOrhDPPxarRYmsb+/v7Gxsbi4CBj+09PT2dlZTIJEHpFCUlVVxdeIMoPh5+E3sJOTk52dnbW1Ncinp6ff3t4Aw2w2iTdz4NQCgGaioigNi46OFufn53t7eyaTCXKYPz4+Njc3x8fHsU3/KR8aGopyEo6JiaFDJEqE3t7e4eHh4uzsDPD6+vr8/Pzo6Ci1Xl9f9Xo9bSstLYWE8FXSgQrCsLAwvLi4uNja2oqbmxtsb29vHx4ezs3NdXV1vb+/84BtUuW7wMBA2ubv7w+YK7TgFQqFhYWF+Pr6ur+/Pzg4eHp66u7uJpW+vj661djYiGF3d3eUkxAiAwICGCEEYwSwlZWVeH5+vry8NIunJUwoozY8PEzbsBcbGzs0NMQIUA4X9DwkJAQhcrlcJpOJ29vbi4uLu7s7g8EAuKOjgz6TPIT4xDzXhYWFkZGRzs5O+sRLV1dXBwcHe3v737Svrq6ur69pD/H29vaChB9tKF9dXQXM5FAactYOvKen53/w0dERmSGbPzAMaK6rqyNkhhEMnHSRFhIk5PzSQmwjm80Tx8fHDw8PjAoDDDP7bN5ho9EIkoHhF8Fkyeagizkhc9aWsRfM48vLCyUoyXqCZxiYW7aF2IzSgZAR2N3d7e/vJ3nigJxGCJpE4I+Pj6TFevLfgw5jTy8drsw8zJRGEXYorZAOePH9/f3z88MX2P78/EQkTaKKTjqtra3m9aJnDAlLRtRw4hn8Py2SxJ4Rl0RGAAAAAElFTkSuQmCC" alt="David S. Wang" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/blog/static/d2552faa6c8cdf254e63b599f6636099/aff39/avatar.png 1x,
/blog/static/d2552faa6c8cdf254e63b599f6636099/e5b88/avatar.png 1.5x,
/blog/static/d2552faa6c8cdf254e63b599f6636099/88b72/avatar.png 2x" /><img loading="lazy" width="48" height="48" srcset="/blog/static/d2552faa6c8cdf254e63b599f6636099/aff39/avatar.png 1x,
/blog/static/d2552faa6c8cdf254e63b599f6636099/e5b88/avatar.png 1.5x,
/blog/static/d2552faa6c8cdf254e63b599f6636099/88b72/avatar.png 2x" src="/blog/static/d2552faa6c8cdf254e63b599f6636099/aff39/avatar.png" alt="David S. Wang" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><div class="css-0">Hi, my name is David.<br/>This is my blog where i write about my projects and things that intrest me.</div></div><style data-emotion-css="11r1i3o">.css-11r1i3o{-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0;}</style><style data-emotion-css="15qbtrw">.css-15qbtrw{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0;}</style><ul class="css-15qbtrw"><li><a rel="prev" class="css-o7eq5i" href="/blog/wardrobeOS/">← <!-- -->wardrobeOS</a></li><li></li></ul></footer></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/system-call/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-bd2fd6b0d1e6c7840162.js"],"app":["/app-3d8cf471c6d272398fde.js"],"component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js":["/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-af5dedea4bd4351ecda6.js"],"component---node-modules-gatsby-theme-blog-core-src-templates-posts-query-js":["/component---node-modules-gatsby-theme-blog-core-src-templates-posts-query-js-5323bdedc592e1110ff7.js"]};/*]]>*/</script><script src="/blog/polyfill-bd2fd6b0d1e6c7840162.js" nomodule=""></script><script src="/blog/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-af5dedea4bd4351ecda6.js" async=""></script><script src="/blog/commons-3983a7b41e047dedbd62.js" async=""></script><script src="/blog/app-3d8cf471c6d272398fde.js" async=""></script><script src="/blog/framework-256fdde5199f9087be1b.js" async=""></script><script src="/blog/styles-9411612e31e4f14527d1.js" async=""></script><script src="/blog/webpack-runtime-a91d46373f0daea63f12.js" async=""></script></body></html>