{"componentChunkName":"component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js","path":"/system-call/","result":{"data":{"site":{"siteMetadata":{"title":"[errorcodes@DWS ~]$","social":[{"name":"Linkedin","url":"https://github.com/dwshuo"},{"name":"Github","url":"https://github.com/dwshuo"}]}},"blogPost":{"__typename":"MdxBlogPost","id":"a1009c33-02db-5832-9287-9f876373c55a","excerpt":"\nThis article is part of a series on the linux kernel. Today we will be looking at \nLinux system calls, and how you can implement your ownâ€¦","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"System calls\",\n  \"date\": \"2018-10-29\",\n  \"description\": \"Guide to writing your own system calls\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, mdx(\"span\", _extends({\n    parentName: \"p\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"760px\"\n    }\n  }), \"\\n      \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"39.42028985507247%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAABibAAAYmwFJdYOUAAABlklEQVQY01VRy0rDUBDNX7hx40JEXIiICrpQRFeKWupG60IREd1LXepSUfBBSzW0StJHetPcpJXaFhVBjdD6/AZtYgSxTaP0kRidBpQ6HC7DzBzOmTuEaZqVSqVcLpdKpWKxCC/khmF818SX+VWGMnQtwCgAiASMRqNRLhymfb6DfTJEUYhh0uk0cEwrIJEkicOYYlnP4aH7wEdHWAYhKZslQIqLRBiMgzwfxFxI4APhsCiKteRnWfZ79uLDowmbPWEbPxoaoba2n2SZAAMsxtzCIlSPJxyJMXvQuXx9ewMcXddhI0iyyovf5T7r6rnoG7jsHzzp7KY3Np8UpWobYZzq6X2sb7hvbX+oq2ds4yei+P72piiKLMsfmnb3+ECTJJqcYi0wkw7K5QI7VdugjJacwvQsPzcvzMz6V1bF/zuDQ3pn97yp5aqtQ2zrOG1sptfWn18t5VgsxsXjXDIJwKkUEoRMJlNLBn0WIdbrZUkSEPF6Q4EA/CIBbU3T1Fyu8It8Lgc3qz2VoetqoVD4/PxDXlXhnD8YLHMQgHL1zQAAAABJRU5ErkJggg==')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n  \", mdx(\"img\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"stats\",\n    \"title\": \"stats\",\n    \"src\": \"/blog/static/aa86e53a7f5b27ed5304b595ebbb82ce/3c051/bg.png\",\n    \"srcSet\": [\"/blog/static/aa86e53a7f5b27ed5304b595ebbb82ce/e4d6b/bg.png 345w\", \"/blog/static/aa86e53a7f5b27ed5304b595ebbb82ce/1e043/bg.png 690w\", \"/blog/static/aa86e53a7f5b27ed5304b595ebbb82ce/3c051/bg.png 760w\"],\n    \"sizes\": \"(max-width: 760px) 100vw, 760px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  })), \"\\n    \"), \"\\nThis article is part of a series on the linux kernel. Today we will be looking at\\nLinux system calls, and how you can implement your own.\"), mdx(\"p\", null, \"To start off if you haven\\u2019t already set up your enviroment for kernel development,\\nyou can click here to follow a guide I wrote on that topic. \"), mdx(\"h2\", {\n    \"id\": \"proposing-a-problem\"\n  }, \"Proposing a problem\"), mdx(\"p\", null, \"Instead of writing a system call that doesn\\u2019t really do anything, lets make things\\na little more intresting. I will propose a probelm and we will attempt to resolve\\nit by implmenting our very own system call.\"), mdx(\"p\", null, \"In this problem, we have a basic server and client written in C, the code for both\\ncan be \", mdx(\"a\", {\n    href: \"https://github.com/DWShuo/syscall-demo\",\n    target: \"_blank\"\n  }, \"found here\"), \".\"), mdx(\"p\", null, \"The server will attempt to send 5 messages to a connected client, while the client\\ndisplays those messages as they are received. \"), mdx(\"p\", null, \"Below, is a small snippit from our client code.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-c\"\n  }), \"void recv_msg(int sockfd){\\n  char buffer[256];\\n\\n  sleep(5); //Why does this brick our code?\\n\\n  while(recv(sockfd,buffer,256,0)>0){\\n    printf(\\\"%s\\\",buffer);\\n  }\\n  printf(\\\"No more data\\\\n\\\");\\n} \\n\")), mdx(\"p\", null, \"The code snippet is simply a function wrapped around the typical client recv\\nprocedures, the only exception being the sleep call. \"), mdx(\"img\", {\n    \"src\": \"/blog/ce154d37eb250ef86b9376f34b898548/broken.gif\",\n    \"alt\": \"drawing\",\n    \"width\": 600\n  }), mdx(\"p\", null, \"As we can see the sleep call breaks our code quite a bit, we only see three out of\\nthe five messages on the client side. In the next section we will attempt to solve\\nthis by writing our own system call.\"), mdx(\"h2\", {\n    \"id\": \"setting-up-system-calls\"\n  }, \"Setting up system calls\"), mdx(\"p\", null, \"System calls can be thought of as interrupts, in fact it is implmented as software\\ninterrupts. To explain this we can take a look at the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"syscall\"), \" assembly\\ninstruction.\"), mdx(\"p\", null, \"Without getting to much into low level assembly and registers, the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"syscall\"), \"\\ninstruction causes an exception and transfers control to an exceptions handler,\\nthe way it determines which exception handler to call is by grabbing the system\\ncall number from the general purpose registers, most likely \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"rax\"), \" if you are\\nusing \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"x86_64\")), mdx(\"p\", null, \"System call numbers are unique numbers assigned to each system call. These unique\\nnumber are stored in the systemcall table located at\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/arch/x86/entry/syscall/syscall_64.tbl\"), \".\"), mdx(\"p\", null, \"Our first step then is to add our custom system call to this table. Go ahead and\\nopen up the table using your favorite text editor, and navigate down to the end of\\n64-bit syscall entries, for me the last syscall number was 334, this could be\\ndifferent for you. \"), mdx(\"img\", {\n    \"src\": \"/blog/0610c373cab1f79026b1386e133a3a35/systable.gif\",\n    \"alt\": \"drawing\",\n    \"width\": 600\n  }), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"335   common  read_lines       __x64_sys_read_lines\\n\")), mdx(\"p\", null, \"The above is what my system call entry looks like. Note that each column is\\nseperated by tabs not spaces.\"), mdx(\"p\", null, \"The first number indicates the syscall number, I choose 335 since its the next\\navailable number after 334.\"), mdx(\"p\", null, \"The second column \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"common\"), \" indicates that this system call is used by both 32-bit\\nand 64-bit CPUs.\"), mdx(\"p\", null, \"The third column indicates the system call\\u2019s name, in this case \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"read_lines\")), mdx(\"p\", null, \"Finally the fourth column indicates the name of the function implmenting it,\\nconvention dictates that it should be prefixed with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"sys_\"), \".\"), mdx(\"h2\", {\n    \"id\": \"writing-system-calls\"\n  }, \"Writing system calls\"), mdx(\"p\", null, \"The final step in making our own system call is to write the system call function.\\nTradtionally miscellaneous system calls should be written in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"kernel/sys.c\"), \", but\\nsince our system call modifies read behavior we add our changes to\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"fs/read_write.c\"), \".\"), mdx(\"p\", null, \"Now if we recall the original problem, where by adding the sleep call in the client,\\nwe create a unwanted behavior where only three out of the five messages received\\nwere being displayed.\"), mdx(\"p\", null, \"The culprit behind this behavior has to do with C string\\u2019s null terminators. Recall\\nthat all C strings are terminate by \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"\\\"\\\\0\\\"\"), \" thus sleeping in between receives, we\\nend up stacking strings behind strings. Now think about how printf would behave if\\nwe pass it one of these string, how would it know when to stop? \"), mdx(\"p\", null, \"Below is the system call solution to fix our problem. \"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-c\"\n  }), \"SYSCALL_DEFINE3(read_lines, int, fd, char __user *, bf, size_t, count){\\n  int read_count = 0;\\n  int single_read_count;\\n  char __user * last;\\n  last = buf + count - 1;\\n  while (1){\\n    single_read_count = ksys_read(fd, last, 1);\\n    if (single_read_count == 0){\\n      // We have exhausted the input stream\\n      return read_count;\\n    }\\n    buf[read_count++] = *last;\\n    if (read_count == count){\\n      // We have exhausted the output buffer \\n      return read_count;\\n    }\\n    if (*last == '\\\\0'){   \\n      // We have reached the null terminator\\n      return read_count;\\n    }\\n  }  \\n  // Something is really wrong here.\\n  return -1;\\n}\\n\")), mdx(\"p\", null, \"One thing that stands out the most from this code is the function decleration,\\ninstead of the usual C style function decleration, we have this strange\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SYSCALL_DEFINE3\"), \" decleration. \"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SYSCALL_DEFINE\"), \" is acutally a class of MACROS defined in\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"include/linux/syscalls.h\"), \". If we look at the signature of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SYSCALL_DEFINE3\"), \" we\\nsee that it first takes in the syscall name, the type of the first argument, the\\nfirst argument, the type of the second argument, the second argument, and so on.\\nIt is then clear that the 3 in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SYSCALL_DEFINE3\"), \" indicates the number of arguments\\nthe syscall takes in.\"), mdx(\"p\", null, \"The code itself is rather simplistic, we keep a counter while we read our input.\\nOnce we reach the max buffer size, or hit an null terminator, we return the number\\nof bytes read, just like how the original read system call would do.\"), mdx(\"p\", null, \"Now all we need to do is build our kernel and we should be good to go.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"make\\nsudo make modules_install\\nsudo make install\\n\")), mdx(\"p\", null, \"Followed by a reboot, make sure to select you new kernel, although by deafult grub\\nshould select the newest version of the kernel.\"), mdx(\"p\", null, \"To use our new system call we need to make some small changes to our client.c \"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-c\"\n  }), \"#define SYS_read_lines 335\\nvoid recv_msg(int sockfd){\\n  char buffer[256];\\n  ssize_t nbytes = 0;\\n\\n  sleep(5); //no longer break our code\\n\\n  while(syscall(SYS_read_lines,buffer,256,0)>0){\\n    printf(\\\"%s\\\",buffer);\\n  }\\n  printf(\\\"No more data\\\\n\\\");\\n}\\n\")), mdx(\"p\", null, \"First we defined our syscall and gave it a name, next we use the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"syscall()\"), \"\\nfunction provided by the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GNU C library\"), \" to call our system call. The provided\\nsyscall function handles the syscall interrupt for us, such that we dont have to\\ntrigger it manually.\"), mdx(\"undefined\", null, mdx(\"img\", {\n    \"src\": \"/blog/1eb46f8827c13e568644a3f968243798/fixed.gif\",\n    \"alt\": \"drawing\",\n    \"width\": 600\n  }), \"\\nAs you can see our system call fixed the problem we had orginally proposed. \\nCongratulations now you know how to write your own system calls. \"), mdx(\"h2\", {\n    \"id\": \"bonus-creating-kernel-patch\"\n  }, \"Bonus: Creating kernel patch\"), mdx(\"p\", null, \"Now that you have made your own system call. I bet you are excited to share your\\nawesome new syscall with your friends, but how would you go about sharing it? I hope\\nyou are not thinking about sending the entire kernel source code to them.\"), mdx(\"p\", null, \"We can easily share our kernel changes by creating a kernel patch.\"), mdx(\"p\", null, \"If you\\u2019ve followed my previous guide on how to setup your enviroment for kernel\\ndevolpment, then you can just followed the steps below, otherwise some modifications\\nmight be required.\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Creating kernel patch:\")), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"First run the command \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"make mrproper\"), \" in both linux-4.18.5-original and linux-4.18.5-dev, this gets rid of any intermediate build files we have left over, we dont want to include those in our patch file.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Next we run \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"diff -rcNP linux-4.9.45-original linux-4.18.5-dev -x signing_key.* -x x509.genkey -x fixdep -x objtool -x inat-tables.c > mypatch.diff\"))), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Applying kernel patch:\")), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Navigate to the directory where you want to apply the kernel patch eg. \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"cd linux-4.18.5-dev\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Next run \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"patch -p1 < ../mypatch.diff\"))));\n}\n;\nMDXContent.isMDXComponent = true;","slug":"/system-call/","title":"System calls","tags":[],"date":"October 29, 2018","image":null,"imageAlt":null,"socialImage":null},"previous":{"__typename":"MdxBlogPost","id":"f44ef005-72bb-5348-99c5-b5658c98a433","excerpt":"I had two goals in mind when I set out to start this project. The first goal was to \nteach myself about android development and the secondâ€¦","slug":"/wardrobeOS/","title":"wardrobeOS","date":"October 27, 2018"},"next":null},"pageContext":{"id":"a1009c33-02db-5832-9287-9f876373c55a","previousId":"f44ef005-72bb-5348-99c5-b5658c98a433","maxWidth":1380}},"staticQueryHashes":["2744905544","3090755652","386998304","764694655"]}